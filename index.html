<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Pomodorer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" href="timer.png"/>
    <style>
        body { text-align: center; color: #555; }
        button {
            background: #666;
            border: none;
            padding: .5em .8em;
            cursor: pointer;
            font-family: arial;
            color: #eee;
            min-width: 85px;
        }
        .controls {
            margin-top: 5px;
        }
        .timer {
            width: 180px;
            margin-left: auto;
            margin-right: auto;
        }
        .timer-time {
            font-size: 5em;
            font-family: monospace;
            color: #333;
        }
        .timer-controls-pause { display: none; }
        .playing .timer-controls-start { display: none; }
        .playing .timer-controls-pause { display: initial; }
        .task { text-align: center; margin-top: 2em; }
        .task-name-set { padding: .8em 1.2em; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <div class="main">
        <div class="timer">
            <audio class="timer-audio"></audio>
            <div class="timer-time">25:00</div>
            <div class="timer-controls controls">
                <button class="timer-controls-start">Start</button>
                <button class="timer-controls-pause">Pause</button>
                <button class="timer-controls-reset">Reset</button>
            </div>
        </div>
        <div class="special-controls controls">
            <button class="controls-pomodoro">Pomodoro</button>
            <button class="controls-break">Break</button>
        </div>
        <div class="controls">
            <a class="bookmarklet" href="javascript:void(0)">Pomodorer</a>
        </div>
        <div class="task">
            <span class="task-name"></span>
        </div>
    </div>

    <script id="bookmarklet-script" type="text/bookmarklet">
        javascript:(function() {
            var title;
            var gitlabSidebar = document.querySelector('.issue-boards-sidebar .issuable-header-text');
            if (gitlabSidebar) {
                title = gitlabSidebar.querySelector('span').innerText.trim() + ' ' + gitlabSidebar.querySelector('strong').innerText.trim();
            }

            var w = window.open('{{URL}}?v=0.1' + (title ? '&title=' + encodeURIComponent(title) : ''));
        })()
    </script>
    <script>
        var url = [location.protocol, '//', location.host, location.pathname].join('')
        var bookmarkletScript = document.getElementById('bookmarklet-script').innerHTML
        document.querySelector('.bookmarklet').setAttribute('href', bookmarkletScript.replace('{{URL}}', url))

        var audio = document.querySelector('.timer-audio')
        var timer = Timer()
        var currentPhase

        var POMODORO_MS = 25 * 60 * 1000
        var BREAK_MS = 5 * 60 * 1000

        var timerContainer = document.querySelector('.timer')
        var timerTimeDiv = document.querySelector('.timer-time')
        var timerStartBtn = document.querySelector('.timer-controls-start')
        var timerPauseBtn = document.querySelector('.timer-controls-pause')
        var timerResetBtn = document.querySelector('.timer-controls-reset')
        var pomodoroBtn = document.querySelector('.controls-pomodoro')
        var breakBtn = document.querySelector('.controls-break')
        var taskNameSpan = document.querySelector('.task-name')

        timerStartBtn.onclick = function() { timer.start() }
        timerPauseBtn.onclick = function() { timer.pause() }
        timerResetBtn.onclick = function() { timer.reset() }
        pomodoroBtn.onclick = function() { setPhase('Pomodoro', 25); timer.start() }
        breakBtn.onclick = function() { setPhase('Break', 5); timer.start() }
        
        timer.onstart = function() { refreshTitle(); timerContainer.classList.add('playing') }
        timer.onpause = function() { refreshTitle(); timerContainer.classList.remove('playing') }
        timer.onupdate = function(formattedTime) { refreshTitle(); timerTimeDiv.innerHTML = formattedTime }
        timer.oncomplete = function() { audio.src = 'ding.wav'; audio.play(); notify(currentPhase + ' ended') }

        setPhase('Pomodoro', 25)
        askNotificationPermission()
        var params = getParams(location.search.substr(1))
        setTaskTitle(params.title)


        function setTaskTitle(title) {
            if (title) {
                taskNameSpan.classList.add('task-name-set')
                taskNameSpan.innerHTML = params.title
            } else {
                taskNameSpan.classList.remove('task-name-set')
                taskNameSpan.innerHTML = ''
            }
        }

        function getParams(uriEncoded) {
            return uriEncoded.split('&')
                .reduce(function (p, ex) {
                    var e = ex.split('=')
                    p[decodeURIComponent(e[0])] = decodeURIComponent(e[1])
                    return p
                }, {})
        }
        
        function refreshTitle() {
            document.title = [
                timer.isRunning() ? timer.formattedTime() + ' | ' : '',
                'Pomodorer'
            ].join('')
        }

        function setPhase(phase, minutes) {
            currentPhase = phase
            timer.totalMs(minutes * 60 * 1000)
        }

        function formatMs(ms) {
            var totalSec = Math.ceil(ms / 1000)
            var s = ('0' + (totalSec % 60)).substr(-2)
            var m = ('0' + (Math.floor(totalSec / 60))).substr(-2)
            return [m, s].join(':')
        }

        function Timer () {
            var me = {}
            var interval
            var totalMs = 1000
            var leftMs = 0
            var lastDate
            var lastFormatted

            
            function loop() {
                var now = Date.now()
                var elapsedMs = Date.now() - lastDate
                lastDate = now

                if (leftMs <= 0)
                    return
                
                leftMs = Math.max(leftMs - elapsedMs, 0)
                update()
                if (leftMs === 0) {
                    me.oncomplete()
                    me.pause()
                }
            }

            function update() {
                var formatted = formatMs(leftMs)
                if (formatted !== lastFormatted) {
                    lastFormatted = formatted
                    me.onupdate(formatted)
                }
            }

            me.start = function() {
                if (interval)
                    return me
                if (!leftMs)
                    leftMs = totalMs
                lastDate = Date.now()
                interval = setInterval(loop, 100)
                me.onstart()
                return me
            }

            me.pause = function() {
                if (!interval)
                    return me
                clearInterval(interval)
                interval = 0
                me.onpause()
                return me
            }

            me.reset = function() {
                leftMs = totalMs
                update()
                return me
            }

            me.totalMs = function(ms) {
                if (!ms)
                    return totalMs
                totalMs = ms
                me.reset()
                return me
            }

            me.isRunning = function() { return !!interval }
            me.formattedTime = function() { return lastFormatted }

            return me
        }

        function askNotificationPermission() {
            if (!('Notification' in window))
                return
            if (Notification.permission === 'granted')
                return
            /*if (Notification.permission === 'denied')
                return*/
            Notification.requestPermission()
        }

        function notify(text) {
            if (!('Notification' in window))
                return
            var n = new Notification(text, { icon: 'timer.png' })
            n.onclick = function() { window.focus(); n.close() }
        }
    </script>
</body>
</html>